<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="utf-8">
  <title>MES Batch Sender âš¡ </title>
  <style>
    body { font-family: Calibri, sans-serif; background:#f7f9fc; margin:0; padding:0; }
    .container {
      max-width: 900px; margin: 30px auto; background: white;
      padding: 25px 30px; border-radius: 14px;
      box-shadow: 0 0 12px rgba(0,0,0,0.1);
    }
    h1 { text-align:center; color:#0057b7; }
    label { font-weight:600; display:block; margin-top:10px; }
    input, textarea, button {
      width:100%; margin:6px 0; padding:10px; border-radius:6px;
      border:1px solid #ccc; font-size:15px;
    }
    textarea { resize:vertical; }
    button {
      background:#0057b7; color:white; border:none; font-weight:bold;
      cursor:pointer; transition:0.3s;
    }
    button:hover { background:#0072ff; }
    button:disabled { background:#6c757d; cursor:not-allowed; }
    #progress { width:100%; background:#e5e5e5; border-radius:5px; margin-top:10px; height:14px; }
    #bar { height:14px; background:linear-gradient(90deg,#00c851,#007e33); width:0%; transition:width 0.3s; }
    pre {
      background:#f0f0f0; padding:10px; border-radius:8px;
      max-height:400px; overflow-y:auto; font-size:12px;
      white-space:pre-wrap; line-height:1.2;
      font-family: 'Courier New', monospace;
    }
    .btn-row { display:flex; gap:10px; margin-top:10px; }
    .btn-row button { flex:1; }
    .file-input-row { display:flex; gap:10px; align-items:center; }
    .file-input-row input[type="file"] { flex:2; }
    .file-input-row button { flex:1; }
    .stats { 
      background: #e8f4fd; 
      padding: 10px; 
      border-radius: 6px; 
      margin: 10px 0;
      font-weight: bold;
    }
    .error { color: red; }
    .success { color: green; }
  </style>
</head>
<body>
  <div class="container">
    <h1>âš¡ MES Batch Sender (Parallel + Retry + Stop/Pause + Timer)</h1>
    <p>Gá»­i hÃ ng loáº¡t yÃªu cáº§u MES song song, cÃ³ retry, táº¡m dá»«ng, vÃ  Ä‘o thá»i gian.</p>

    <label>ğŸ”¹ Package (mxpackage):</label>
    <input id="pkg" placeholder="M_HAR-0207_1_HAR0294RGL001001_01_02" value="M_HAR-0207_1_HAR0294RGL001001_01_02">

    <label>ğŸ”¹ Danh sÃ¡ch (má»—i dÃ²ng: opserial,mcid[,processtype])</label>
    <textarea id="list" rows="8" placeholder="1,M10002390
2,M10002391,FA
3,M10002396,QA">1,M10002390
2,M10002391,FA
3,M10002396,QA</textarea>

    <label>ğŸ”¹ Import tá»« file CSV/TXT:</label>
    <div class="file-input-row">
      <input type="file" id="fileInput" accept=".csv,.txt,.xlsx">
      <button id="importBtn" style="background:#6c757d">ğŸ“ Import File</button>
    </div>

    <label>ğŸ”¹ Endpoint:</label>
    <input id="endpoint" value="https://mes-system.chiscoong-cloudflare-com.workers.dev/">

    <label>ğŸ”¹ Sá»‘ luá»“ng song song:</label>
    <input id="threads" type="number" min="1" max="20" value="3">

    <label>ğŸ”¹ Giá»›i háº¡n request/giÃ¢y:</label>
    <input id="rateLimit" type="number" min="1" max="1000" value="10" placeholder="Sá»‘ request tá»‘i Ä‘a má»—i giÃ¢y">

    <div class="btn-row">
      <button id="run">â–¶ï¸ Gá»­i hÃ ng loáº¡t</button>
      <button id="pause" style="background:#ffc107; display:none;">â¸ï¸ Táº¡m dá»«ng</button>
      <button id="stop" style="background:#dc3545; display:none;">â¹ï¸ Dá»«ng</button>
    </div>

    <div id="progress"><div id="bar"></div></div>

    <div id="stats" class="stats" style="display:none;">
      ğŸ“Š Thá»‘ng kÃª: Äang xá»­ lÃ½...
    </div>

    <h3>ğŸ“‹ Log tiáº¿n trÃ¬nh:</h3>
    <pre id="log">ChÆ°a cÃ³ hoáº¡t Ä‘á»™ng nÃ o...</pre>
    
    <div class="btn-row">
      <button id="export" style="background:#28a745">ğŸ’¾ Xuáº¥t káº¿t quáº£ CSV</button>
      <button id="clearLog" style="background:#6c757d">ğŸ—‘ï¸ XÃ³a Log</button>
      <button id="testConnection" style="background:#17a2b8">ğŸ”— Test Káº¿t ná»‘i</button>
    </div>
  </div>

  <script>
  let isPaused = false;
  let isStopped = false;
  let currentBatchStart = null;

  // â±ï¸ Helper format mm:ss
  function formatTime(ms) {
    const totalSec = Math.floor(ms / 1000);
    const m = Math.floor(totalSec / 60).toString().padStart(2, "0");
    const s = (totalSec % 60).toString().padStart(2, "0");
    return `${m}:${s}`;
  }

  // ğŸ“Š Cáº­p nháº­t thá»‘ng kÃª
  function updateStats(results, total, elapsedTime) {
    const statsEl = document.getElementById("stats");
    if (!results.length) {
      statsEl.style.display = 'none';
      return;
    }
    
    const success = results.filter(r => r.success).length;
    const failed = results.filter(r => !r.success && r.status !== "STOPPED").length;
    const stopped = results.filter(r => r.status === "STOPPED").length;
    const pending = total - results.length;
    
    const avgRetries = results.length > 0 
      ? (results.reduce((sum, r) => sum + (r.retries || 0), 0) / results.length).toFixed(2)
      : "0.00";
    
    const avgDuration = results.length > 0
      ? (results.reduce((sum, r) => sum + (parseFloat(r.duration) || 0), 0) / results.length).toFixed(2)
      : "0.00";
    
    const currentRate = elapsedTime > 0 ? (results.length / (elapsedTime / 1000)).toFixed(2) : "0.00";
    
    statsEl.innerHTML = `
      ğŸ“Š Thá»‘ng kÃª: 
      Tá»•ng: ${total} | 
      ÄÃ£ xá»­ lÃ½: ${results.length} | 
      ThÃ nh cÃ´ng: <span style="color:green">${success}</span> | 
      Tháº¥t báº¡i: <span style="color:red">${failed}</span> | 
      ÄÃ£ dá»«ng: ${stopped} | 
      Chá»: ${pending} |
      Retry TB: ${avgRetries} | 
      Thá»i gian TB: ${avgDuration}s |
      Tá»‘c Ä‘á»™: ${currentRate} req/s
    `;
    statsEl.style.display = 'block';
  }

  // ğŸš¨ Validation chi tiáº¿t
  function validateInputs() {
    const pkg = document.getElementById("pkg").value.trim();
    const lines = document.getElementById("list").value.split("\n").map(x => x.trim()).filter(Boolean);
    const endpoint = document.getElementById("endpoint").value.trim();
    
    if (!pkg) throw new Error("â— Vui lÃ²ng nháº­p package!");
    if (!lines.length) throw new Error("â— Vui lÃ²ng nháº­p danh sÃ¡ch cÃ´ng Ä‘oáº¡n / mÃ¡y!");
    if (!endpoint) throw new Error("â— Vui lÃ²ng nháº­p endpoint!");
    
    // Validate endpoint URL
    try {
      new URL(endpoint);
    } catch (e) {
      throw new Error("â— Endpoint khÃ´ng há»£p lá»‡!");
    }
    
    // Validate tá»«ng dÃ²ng
    const invalidLines = [];
    lines.forEach((line, idx) => {
      const parts = line.split(",").map(x => x.trim());
      if (parts.length < 2 || !parts[0] || !parts[1]) {
        invalidLines.push(`DÃ²ng ${idx + 1}: "${line}"`);
      }
    });
    
    if (invalidLines.length > 0) {
      throw new Error(`DÃ²ng khÃ´ng há»£p lá»‡:\n${invalidLines.join("\n")}`);
    }
    
    return { pkg, lines, endpoint };
  }

  // ğŸ”„ Rate Limiter class
  class RateLimiter {
    constructor(requestsPerSecond) {
      this.delay = 1000 / requestsPerSecond;
      this.lastRequest = 0;
    }
    
    async wait() {
      const now = Date.now();
      const waitTime = this.lastRequest + this.delay - now;
      if (waitTime > 0) {
        await new Promise(r => setTimeout(r, waitTime));
      }
      this.lastRequest = Date.now();
    }
  }

  // ğŸ“ Append log vá»›i auto-scroll
  function appendLog(message, isError = false) {
    const log = document.getElementById("log");
    const timestamp = new Date().toLocaleTimeString();
    const logEntry = `[${timestamp}] ${message}`;
    
    log.textContent += logEntry + "\n";
    log.scrollTop = log.scrollHeight;
    
    // Log ra console Ä‘á»ƒ debug
    if (isError) {
      console.error(message);
    } else {
      console.log(message);
    }
  }

  // âš™ï¸ Loading state management
  function setLoadingState(loading) {
    document.getElementById("run").disabled = loading;
    document.getElementById("export").disabled = loading;
    document.getElementById("importBtn").disabled = loading;
    document.getElementById("testConnection").disabled = loading;
    document.getElementById("pause").style.display = loading ? "block" : "none";
    document.getElementById("stop").style.display = loading ? "block" : "none";
    
    if (!loading) {
      isPaused = false;
      isStopped = false;
      document.getElementById("pause").textContent = "â¸ï¸ Táº¡m dá»«ng";
    }
  }

  // ğŸ“§ Gá»­i request vá»›i timeout
  async function sendRequest({endpoint, pkg, opserial, mcid, processtype}) {
    const url = `${endpoint}?mxpackage=${encodeURIComponent(pkg)}&opserial=${opserial}&mcid=${mcid}${processtype ? `&processtype=${processtype}` : ''}`;
    const start = Date.now();
    
    try {
      const controller = new AbortController();
      const timeoutId = setTimeout(() => controller.abort(), 30000); // 30s timeout
      
      const res = await fetch(url, {
        method: 'GET',
        signal: controller.signal,
        headers: {
          'Accept': 'application/json',
        },
        mode: 'cors' // Explicitly set CORS mode
      });
      
      clearTimeout(timeoutId);
      
      const text = await res.text();
      const duration = ((Date.now() - start) / 1000).toFixed(2);
      
      // Kiá»ƒm tra response
      let ok = res.ok;
      let status = res.status;
      
      try {
        const jsonResponse = JSON.parse(text);
        ok = ok && jsonResponse.IsSuccess === true;
      } catch (e) {
        // Náº¿u khÃ´ng parse Ä‘Æ°á»£c JSON, xem nhÆ° failed
        ok = false;
        status = 'INVALID_JSON';
      }
      
      return { ok, status, body: text, duration };
      
    } catch (err) {
      const duration = ((Date.now() - start) / 1000).toFixed(2);
      return { 
        ok: false, 
        error: err.name === 'AbortError' ? 'Timeout after 30s' : err.message, 
        duration 
      };
    }
  }

  // ğŸ” Retry logic
  async function sendWithRetry(task, retries = 3, delay = 1000) {
    for (let attempt = 1; attempt <= retries; attempt++) {
      if (isStopped) return { ok: false, status: "STOPPED", attempt, duration: 0 };
      
      const res = await sendRequest(task);
      
      if (res.ok) return { ...res, attempt };
      
      if (attempt < retries) {
        appendLog(`   ğŸ” [${task.index}] Retry ${attempt}/${retries}...`);
        await new Promise(r => setTimeout(r, delay));
      }
    }
    return { ok: false, attempt: retries, duration: 0 };
  }

  // ğŸ”— Test káº¿t ná»‘i
  async function testConnection() {
    const endpoint = document.getElementById("endpoint").value.trim();
    const pkg = document.getElementById("pkg").value.trim();
    
    if (!endpoint || !pkg) {
      alert("Vui lÃ²ng nháº­p endpoint vÃ  package Ä‘á»ƒ test káº¿t ná»‘i!");
      return;
    }
    
    try {
      setLoadingState(true);
      appendLog("ğŸ”— Äang test káº¿t ná»‘i...");
      
      const testUrl = `${endpoint}?mxpackage=${encodeURIComponent(pkg)}&opserial=1&mcid=TEST123`;
      const response = await fetch(testUrl, { method: 'GET' });
      
      if (response.ok) {
        appendLog("âœ… Káº¿t ná»‘i thÃ nh cÃ´ng! Server Ä‘ang hoáº¡t Ä‘á»™ng.", false);
      } else {
        appendLog(`âŒ Káº¿t ná»‘i tháº¥t báº¡i! Status: ${response.status}`, true);
      }
    } catch (error) {
      appendLog(`âŒ Lá»—i káº¿t ná»‘i: ${error.message}`, true);
    } finally {
      setLoadingState(false);
    }
  }

  // ğŸ“ File import handler
  document.getElementById("importBtn").onclick = () => {
    document.getElementById("fileInput").click();
  };

  document.getElementById("fileInput").onchange = (e) => {
    const file = e.target.files[0];
    if (!file) return;
    
    const reader = new FileReader();
    reader.onload = (event) => {
      document.getElementById("list").value = event.target.result;
      appendLog(`ğŸ“ ÄÃ£ import file: ${file.name} (${file.size} bytes)`);
    };
    reader.onerror = () => {
      appendLog("âŒ Lá»—i Ä‘á»c file!", true);
    };
    reader.readAsText(file);
    
    // Reset file input
    e.target.value = '';
  };

  // â¯ï¸ Pause/Resume handler
  document.getElementById("pause").onclick = () => {
    isPaused = !isPaused;
    document.getElementById("pause").textContent = isPaused ? "â–¶ï¸ Tiáº¿p tá»¥c" : "â¸ï¸ Táº¡m dá»«ng";
    appendLog(isPaused ? "â¸ï¸ ÄÃ£ táº¡m dá»«ng" : "â–¶ï¸ ÄÃ£ tiáº¿p tá»¥c");
  };

  // â¹ï¸ Stop handler
  document.getElementById("stop").onclick = () => {
    if (!isStopped) {
      isStopped = true;
      appendLog("â¹ï¸ Äang dá»«ng quÃ¡ trÃ¬nh gá»­i...");
    }
  };

  // ğŸ§¹ Clear log handler
  document.getElementById("clearLog").onclick = () => {
    document.getElementById("log").textContent = "Log Ä‘Ã£ Ä‘Æ°á»£c xÃ³a...\n";
  };

  // ğŸ”— Test connection handler
  document.getElementById("testConnection").onclick = testConnection;

  // ğŸš€ Main process
  async function runBatchProcess() {
    try {
      setLoadingState(true);
      const { pkg, lines, endpoint } = validateInputs();
      
      const threads = parseInt(document.getElementById("threads").value) || 3;
      const rateLimit = parseInt(document.getElementById("rateLimit").value) || 10;
      const bar = document.getElementById("bar");
      const total = lines.length;
      let done = 0;
      const results = [];

      appendLog(`âš¡ Báº¯t Ä‘áº§u gá»­i ${total} dÃ²ng (song song ${threads} luá»“ng, giá»›i háº¡n ${rateLimit} req/giÃ¢y)...`);
      
      currentBatchStart = Date.now();
      const queue = lines.map((line, idx) => {
        const [opserial, mcid, processtype] = line.split(",").map(x => x.trim());
        return { opserial, mcid, processtype, index: idx + 1 };
      });

      const rateLimiter = new RateLimiter(rateLimit);

      async function worker() {
        while (queue.length > 0 && !isStopped) {
          if (isPaused) {
            await new Promise(r => setTimeout(r, 500));
            continue;
          }

          await rateLimiter.wait();
          const task = queue.shift();
          if (!task || !task.opserial || !task.mcid) {
            appendLog(`âš ï¸ Bá» qua dÃ²ng khÃ´ng há»£p lá»‡`);
            continue;
          }

          appendLog(`ğŸš€ [${task.index}] Gá»­i ${task.mcid} (op ${task.opserial}${task.processtype ? ',' + task.processtype : ''})...`);

          const res = await sendWithRetry({ endpoint, pkg, ...task });
          const icon = res.ok ? "âœ…" : (res.status === "STOPPED" ? "â¹ï¸" : "âŒ");
          const retryNote = res.attempt > 1 ? ` ğŸ”(${res.attempt} láº§n)` : "";
          const timeNote = res.duration ? ` (${res.duration}s)` : "";
          appendLog(`${icon} [${task.index}] ${task.mcid} â†’ ${res.status || res.error || 'error'}${retryNote}${timeNote}`);

          results.push({
            ...task,
            status: res.status || res.error || "ERROR",
            success: res.ok,
            retries: res.attempt,
            duration: res.duration
          });

          done++;
          bar.style.width = `${(done/total)*100}%`;
          
          // Cáº­p nháº­t thá»‘ng kÃª
          updateStats(results, total, Date.now() - currentBatchStart);
        }
      }

      const workers = Array.from({ length: threads }, () => worker());
      await Promise.all(workers);

      const totalTime = Date.now() - currentBatchStart;
      const avg = totalTime > 0 ? (total / (totalTime / 1000)) : 0;
      
      if (isStopped) {
        appendLog(`\nâ¹ï¸ ÄÃ£ dá»«ng thá»§ cÃ´ng sau ${formatTime(totalTime)}.`);
        appendLog(`ğŸ“Š ÄÃ£ xá»­ lÃ½: ${done}/${total} requests`);
      } else {
        appendLog(`\nğŸ¯ HoÃ n táº¥t toÃ n bá»™ trong ${formatTime(totalTime)} (${avg.toFixed(2)} req/s).`);
      }
      
      window._batchResults = results;
      
    } catch (error) {
      appendLog(`âŒ Lá»—i: ${error.message}`, true);
      console.error('Batch process error:', error);
    } finally {
      setLoadingState(false);
      // Cáº­p nháº­t thá»‘ng kÃª cuá»‘i cÃ¹ng
      if (window._batchResults) {
        updateStats(window._batchResults, window._batchResults.length, Date.now() - currentBatchStart);
      }
    }
  }

  // â–¶ï¸ Run handler
  document.getElementById("run").onclick = runBatchProcess;

  // ğŸ’¾ Export handler
  document.getElementById("export").onclick = () => {
    const data = window._batchResults || [];
    if (!data.length) return alert("ChÆ°a cÃ³ dá»¯ liá»‡u Ä‘á»ƒ xuáº¥t!");
    
    const header = "index,opserial,mcid,processtype,status,success,retries,duration(s)\n";
    const rows = data.map(r => `${r.index},${r.opserial},${r.mcid},${r.processtype||''},${r.status},${r.success},${r.retries},${r.duration}`);
    const blob = new Blob(["\uFEFF" + header + rows.join("\n")], {type:'text/csv;charset=utf-8;'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; 
    a.download = `mes_batch_result_${new Date().toISOString().slice(0,19).replace(/:/g,'-')}.csv`; 
    a.click();
    URL.revokeObjectURL(url);
    
    appendLog(`ğŸ’¾ ÄÃ£ xuáº¥t file: ${a.download}`);
  };

  // ThÃªm event listener Ä‘á»ƒ debug
  document.addEventListener('DOMContentLoaded', function() {
    appendLog("âœ… á»¨ng dá»¥ng Ä‘Ã£ sáºµn sÃ ng!");
    console.log("MES Batch Sender initialized");
  });
  </script>
</body>
</html>
