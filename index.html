<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MES QR Scanner - C√¥ng C·ª• Qu√©t & Ghi D·ªØ Li·ªáu T·ª± ƒê·ªông</title>
  <style>
    :root {
      --primary: #0057b7;
      --primary-light: #0072ff;
      --primary-dark: #004494;
      --success: #28a745;
      --warning: #ffc107;
      --danger: #dc3545;
      --info: #17a2b8;
      --light: #f8f9fa;
      --dark: #343a40;
      --gray: #6c757d;
      --gray-light: #e9ecef;
      --border-radius: 8px;
      --box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      --transition: all 0.3s ease;
    }
    
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    
    body { 
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
      background: linear-gradient(135deg, #f5f7fa 0%, #e4e8f0 100%);
      margin: 0; 
      padding: 20px; 
      color: #333;
      line-height: 1.6;
      min-height: 100vh;
    }
    
    .container {
      max-width: 1200px; 
      margin: 0 auto; 
      background: white;
      padding: 30px; 
      border-radius: 12px;
      box-shadow: var(--box-shadow);
    }
    
    .header {
      text-align: center;
      margin-bottom: 30px;
      padding-bottom: 20px;
      border-bottom: 2px solid var(--gray-light);
    }
    
    h1 { 
      color: var(--primary); 
      margin-bottom: 10px;
      font-weight: 700;
      font-size: 2.2rem;
    }
    
    .subtitle {
      color: var(--gray);
      margin-bottom: 15px;
      font-size: 1.2rem;
    }
    
    .description {
      background: linear-gradient(135deg, #e8f4fd 0%, #d1e7ff 100%);
      padding: 20px;
      border-radius: var(--border-radius);
      margin-bottom: 25px;
      border-left: 4px solid var(--info);
    }
    
    .description h3 {
      color: var(--primary);
      margin-bottom: 10px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .description ul {
      padding-left: 20px;
      margin: 10px 0;
    }
    
    .description li {
      margin-bottom: 8px;
    }
    
    .card {
      background: var(--light);
      border-radius: var(--border-radius);
      padding: 25px;
      margin-bottom: 25px;
      border-left: 4px solid var(--primary);
      transition: var(--transition);
    }
    
    .card:hover {
      transform: translateY(-2px);
      box-shadow: var(--box-shadow);
    }
    
    .card-title {
      font-weight: 600;
      margin-top: 0;
      color: var(--primary);
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 15px;
      font-size: 1.3rem;
    }
    
    .config-group {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin-bottom: 20px;
    }
    
    @media (max-width: 768px) {
      .config-group {
        grid-template-columns: 1fr;
      }
    }
    
    .form-group {
      margin-bottom: 20px;
    }
    
    label { 
      font-weight: 600; 
      display: block; 
      margin-bottom: 8px;
      color: var(--dark);
    }
    
    input, textarea, select, button {
      width: 100%; 
      margin: 6px 0; 
      padding: 12px; 
      border-radius: var(--border-radius);
      border: 1px solid #ddd; 
      font-size: 15px;
      transition: var(--transition);
      font-family: inherit;
    }
    
    input:focus, textarea:focus, select:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(0, 87, 183, 0.1);
    }
    
    textarea { 
      resize: vertical; 
      min-height: 120px;
      font-family: 'Courier New', monospace;
      line-height: 1.4;
    }
    
    button {
      background: var(--primary); 
      color: white; 
      border: none; 
      font-weight: 600;
      cursor: pointer; 
      transition: var(--transition);
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      padding: 14px;
    }
    
    button:hover { 
      background: var(--primary-light); 
      transform: translateY(-2px);
    }
    
    button:active {
      transform: translateY(0);
    }
    
    button:disabled { 
      background: var(--gray); 
      cursor: not-allowed;
      transform: none;
    }
    
    .btn-primary { background: var(--primary); }
    .btn-success { background: var(--success); }
    .btn-warning { background: var(--warning); color: var(--dark); }
    .btn-danger { background: var(--danger); }
    .btn-info { background: var(--info); }
    .btn-secondary { background: var(--gray); }
    
    #progress { 
      width: 100%; 
      background: #e5e5e5; 
      border-radius: 10px; 
      margin: 25px 0; 
      height: 20px; 
      overflow: hidden;
      box-shadow: inset 0 1px 3px rgba(0,0,0,0.2);
    }
    
    #bar { 
      height: 20px; 
      background: linear-gradient(90deg, #00c851, #007e33); 
      width: 0%; 
      transition: width 0.5s;
      border-radius: 10px;
      position: relative;
    }
    
    #bar::after {
      content: attr(data-progress);
      position: absolute;
      right: 10px;
      top: 50%;
      transform: translateY(-50%);
      color: white;
      font-weight: bold;
      font-size: 12px;
      text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
    }
    
    pre {
      background: #1e1e1e; 
      color: #d4d4d4;
      padding: 20px; 
      border-radius: var(--border-radius);
      max-height: 400px; 
      overflow-y: auto; 
      font-size: 13px;
      white-space: pre-wrap; 
      line-height: 1.4;
      font-family: 'Courier New', monospace;
      border: 1px solid #333;
    }
    
    .btn-row { 
      display: flex; 
      gap: 12px; 
      margin-top: 20px; 
    }
    
    .btn-row button { 
      flex: 1; 
    }
    
    .file-input-row { 
      display: flex; 
      gap: 12px; 
      align-items: center; 
      margin-top: 10px;
    }
    
    .file-input-row input[type="file"] { 
      flex: 2; 
      padding: 8px;
    }
    
    .file-input-row button { 
      flex: 1; 
    }
    
    .stats { 
      background: linear-gradient(135deg, #e8f4fd 0%, #d1e7ff 100%);
      padding: 20px; 
      border-radius: var(--border-radius); 
      margin: 20px 0;
      font-weight: 600;
      border-left: 4px solid var(--info);
      display: none;
    }
    
    .error { color: var(--danger); }
    .success { color: var(--success); }
    .warning { color: var(--warning); }
    
    .help-text {
      font-size: 0.85rem;
      color: var(--gray);
      margin-top: 5px;
      font-style: italic;
    }
    
    .required::after {
      content: " *";
      color: var(--danger);
    }
    
    .template-download {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      color: var(--primary);
      text-decoration: none;
      font-weight: 600;
      margin-top: 10px;
      padding: 10px 15px;
      background: rgba(0, 87, 183, 0.1);
      border-radius: var(--border-radius);
      transition: var(--transition);
      border: 1px solid transparent;
    }
    
    .template-download:hover {
      background: rgba(0, 87, 183, 0.2);
      border-color: var(--primary);
    }
    
    .icon {
      font-size: 1.2rem;
    }
    
    .status-running { color: var(--success); }
    .status-paused { color: var(--warning); }
    .status-stopped { color: var(--danger); }
    
    .log-time {
      color: #6c757d;
      font-size: 0.9em;
    }
    
    .section-title {
      font-size: 1.5rem;
      color: var(--primary);
      margin: 30px 0 20px 0;
      padding-bottom: 10px;
      border-bottom: 2px solid var(--gray-light);
    }
    
    .quick-guide {
      background: #fff3cd;
      border-left: 4px solid var(--warning);
      padding: 15px;
      border-radius: var(--border-radius);
      margin: 15px 0;
    }
    
    .quick-guide h4 {
      color: #856404;
      margin-bottom: 10px;
    }

    @media (max-width: 768px) {
      .container {
        padding: 20px;
      }
      
      .btn-row {
        flex-direction: column;
      }
      
      h1 {
        font-size: 1.8rem;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Header Section -->
    <div class="header">
      <h1>‚ö° MES QR SCANNER ‚ö°</h1>
      <p class="subtitle">C√¥ng C·ª• Ghi Nh·∫≠n D·ªØ Li·ªáu S·∫£n Xu·∫•t T·ª± ƒê·ªông</p>
    </div>

    <!-- Description Section -->
   

    <!-- Configuration Section -->
    <div class="card">
      <h3 class="card-title">‚öôÔ∏è C·∫•u H√¨nh H·ªá Th·ªëng</h3>
      
      <div class="config-group">
        <div class="form-group">
          <label for="endpoint" class="required">Endpoint URL:</label>
          <input type="url" id="endpoint" value="https://mes-qr-scanner.chiscoong-cloudflare-com.workers.dev/" placeholder="https://your-worker.workers.dev/">
          <div class="help-text">ƒê·ªãa ch·ªâ API endpoint cho MES QR SCANNER </div>
        </div>
        
        <div class="form-group">
          <label for="apiKey" class="required">API Key:</label>
          <input type="password" id="apiKey" placeholder="Nh·∫≠p API key c·ªßa b·∫°n" value="mes_user1_pk2024">
          <div class="help-text">Li√™n h·ªá qu·∫£n tr·ªã vi√™n ƒë·ªÉ l·∫•y API Key</div>
        </div>
      </div>
      
      <div class="form-group">
        <label for="pkg" class="required">Package (mxpackage):</label>
        <input id="pkg" placeholder="M_XXX-XXXX_X_XXXXXXXXXXXXXXXX_XX" value="M_HAR-0207_1_HAR0300RGL001001_01_02">
        <div class="help-text">M·ªói package n√™n ƒë∆∞·ª£c x·ª≠ l√Ω trong m·ªôt file CSV ri√™ng</div>
      </div>
    </div>

    <!-- Data Input Section -->
    <div class="card">
      <h3 class="card-title">üìä D·ªØ Li·ªáu C·∫ßn X·ª≠ L√Ω</h3>
      
      <div class="form-group">
        <label for="list" class="required">Danh s√°ch (m·ªói d√≤ng: opserial,mcid[,processtype]):</label>
        <textarea id="list" placeholder="1,M10002390
2,M10002391,FA
3,M10002396,QA">1,60:01:94:3A:74:B5,QA
2,60:01:94:3A:74:B6,FA
3,60:01:94:3A:74:B7,QC</textarea>
        <div class="help-text">Format: opserial (b·∫Øt bu·ªôc), mcid (b·∫Øt bu·ªôc), processtype (t√πy ch·ªçn: QA, FA, QC)</div>
      </div>
      
      <div class="form-group">
        <label>Import t·ª´ file CSV/TXT:</label>
        <div class="file-input-row">
          <input type="file" id="fileInput" accept=".csv,.txt">
          <button id="importBtn" class="btn-secondary">üìÅ Import File</button>
        </div>
        
        <a href="#" id="downloadTemplate" class="template-download">
          üì• T·∫£i file m·∫´u CSV
        </a>
        <div class="help-text">
          C·∫•u tr√∫c file: opserial (c·ªôt A), mcid (c·ªôt B), processtype (c·ªôt C - t√πy ch·ªçn)
        </div>
      </div>
    </div>

    <!-- Control Section -->
    <h3 class="section-title">üéÆ ƒêi·ªÅu Khi·ªÉn Qu√° Tr√¨nh</h3>
    
    <div class="btn-row">
      <button id="run" class="btn-primary">‚ñ∂Ô∏è B·∫Øt ƒê·∫ßu G·ª≠i</button>
      <button id="pause" class="btn-warning" style="display:none;">‚è∏Ô∏è T·∫°m D·ª´ng</button>
      <button id="stop" class="btn-danger" style="display:none;">‚èπÔ∏è D·ª´ng L·∫°i</button>
    </div>

    <!-- Progress Section -->
    <div id="progress">
      <div id="bar" data-progress="0%"></div>
    </div>

    <!-- Statistics Section -->
    <div id="stats" class="stats">
      üìä Th·ªëng k√™: ƒêang x·ª≠ l√Ω...
    </div>

    <!-- Log Section -->
    <h3 class="section-title">üìã Log Ti·∫øn Tr√¨nh</h3>
    <pre id="log">Ch·ªù b·∫Øt ƒë·∫ßu x·ª≠ l√Ω...</pre>
    
    <!-- Action Buttons -->
    <div class="btn-row">
      <button id="export" class="btn-success">üíæ Xu·∫•t K·∫øt Qu·∫£ CSV</button>
      <button id="clearLog" class="btn-secondary">üóëÔ∏è X√≥a Log</button>
      <button id="testConnection" class="btn-info">üîó Test K·∫øt N·ªëi</button>
    </div>
  </div>

  <script>
  // Bi·∫øn to√†n c·ª•c
  let isPaused = false;
  let isStopped = false;
  let currentBatchStart = null;
  let processingStats = {
    total: 0,
    processed: 0,
    success: 0,
    failed: 0
  };

  // ‚è±Ô∏è Helper format mm:ss
  function formatTime(ms) {
    const totalSec = Math.floor(ms / 1000);
    const m = Math.floor(totalSec / 60).toString().padStart(2, "0");
    const s = (totalSec % 60).toString().padStart(2, "0");
    return `${m}:${s}`;
  }

  // üìä C·∫≠p nh·∫≠t th·ªëng k√™
  function updateStats(results, total, elapsedTime) {
    const statsEl = document.getElementById("stats");
    if (!results.length) {
      statsEl.style.display = 'none';
      return;
    }
    
    const success = results.filter(r => r.success).length;
    const failed = results.filter(r => !r.success && r.status !== "STOPPED").length;
    const stopped = results.filter(r => r.status === "STOPPED").length;
    const pending = total - results.length;
    
    const avgRetries = results.length > 0 
      ? (results.reduce((sum, r) => sum + (r.retries || 0), 0) / results.length).toFixed(2)
      : "0.00";
    
    const avgDuration = results.length > 0
      ? (results.reduce((sum, r) => sum + (parseFloat(r.duration) || 0), 0) / results.length).toFixed(2)
      : "0.00";
    
    const currentRate = elapsedTime > 0 ? (results.length / (elapsedTime / 1000)).toFixed(2) : "0.00";
    
    statsEl.innerHTML = `
      <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px;">
        <div>üì¶ T·ªïng: <strong>${total}</strong></div>
        <div>‚úÖ Th√†nh c√¥ng: <strong style="color: green">${success}</strong></div>
        <div>‚ùå Th·∫•t b·∫°i: <strong style="color: red">${failed}</strong></div>
        <div>‚èπÔ∏è ƒê√£ d·ª´ng: <strong>${stopped}</strong></div>
        <div>‚è≥ Ch·ªù x·ª≠ l√Ω: <strong>${pending}</strong></div>
        <div>üîÑ Retry TB: <strong>${avgRetries}</strong></div>
        <div>‚è±Ô∏è Th·ªùi gian TB: <strong>${avgDuration}s</strong></div>
        <div>üöÄ T·ªëc ƒë·ªô: <strong>${currentRate} req/s</strong></div>
      </div>
    `;
    statsEl.style.display = 'block';
  }

  // üö® Validation chi ti·∫øt
  function validateInputs() {
    const endpoint = document.getElementById("endpoint").value.trim();
    const apiKey = document.getElementById("apiKey").value.trim();
    const pkg = document.getElementById("pkg").value.trim();
    const lines = document.getElementById("list").value.split("\n").map(x => x.trim()).filter(Boolean);
    
    if (!endpoint) throw new Error("‚ùó Vui l√≤ng nh·∫≠p endpoint!");
    if (!apiKey) throw new Error("‚ùó Vui l√≤ng nh·∫≠p API Key!");
    if (!pkg) throw new Error("‚ùó Vui l√≤ng nh·∫≠p package!");
    if (!lines.length) throw new Error("‚ùó Vui l√≤ng nh·∫≠p danh s√°ch c√¥ng ƒëo·∫°n / m√°y!");
    
    // Validate endpoint URL
    try {
      new URL(endpoint);
    } catch (e) {
      throw new Error("‚ùó Endpoint kh√¥ng h·ª£p l·ªá!");
    }
    
    // Validate t·ª´ng d√≤ng
    const invalidLines = [];
    lines.forEach((line, idx) => {
      const parts = line.split(",").map(x => x.trim());
      if (parts.length < 2 || !parts[0] || !parts[1]) {
        invalidLines.push(`D√≤ng ${idx + 1}: "${line}"`);
      }
    });
    
    if (invalidLines.length > 0) {
      throw new Error(`D√≤ng kh√¥ng h·ª£p l·ªá:\n${invalidLines.join("\n")}`);
    }
    
    return { endpoint, apiKey, pkg, lines };
  }

  // üìù Append log v·ªõi auto-scroll
  function appendLog(message, isError = false) {
    const log = document.getElementById("log");
    const timestamp = new Date().toLocaleTimeString();
    const logEntry = `<span class="log-time">[${timestamp}]</span> ${message}`;
    
    if (log.textContent === "Ch·ªù b·∫Øt ƒë·∫ßu x·ª≠ l√Ω...") {
      log.innerHTML = logEntry + "\n";
    } else {
      log.innerHTML += logEntry + "\n";
    }
    
    log.scrollTop = log.scrollHeight;
    
    // Log ra console ƒë·ªÉ debug
    if (isError) {
      console.error(message);
    } else {
      console.log(message);
    }
  }

  // ‚öôÔ∏è Loading state management
  function setLoadingState(loading) {
    document.getElementById("run").disabled = loading;
    document.getElementById("export").disabled = loading;
    document.getElementById("importBtn").disabled = loading;
    document.getElementById("testConnection").disabled = loading;
    document.getElementById("pause").style.display = loading ? "flex" : "none";
    document.getElementById("stop").style.display = loading ? "flex" : "none";
    
    if (!loading) {
      isPaused = false;
      isStopped = false;
      document.getElementById("pause").textContent = "‚è∏Ô∏è T·∫°m D·ª´ng";
      document.getElementById("pause").className = "btn-warning";
    }
  }

  // üìß G·ª≠i request v·ªõi timeout v√† API Key
  async function sendRequest({endpoint, apiKey, pkg, opserial, mcid, processtype}) {
    // Th√™m API Key v√†o URL parameter
    const url = `${endpoint}?mxpackage=${encodeURIComponent(pkg)}&opserial=${opserial}&mcid=${mcid}${processtype ? `&processtype=${processtype}` : ''}&apikey=${encodeURIComponent(apiKey)}`;
    const start = Date.now();
    
    try {
      const controller = new AbortController();
      const timeoutId = setTimeout(() => controller.abort(), 30000); // 30s timeout
      
      const res = await fetch(url, {
        method: 'GET',
        signal: controller.signal,
        headers: {
          'Accept': 'application/json',
        },
        mode: 'cors'
      });
      
      clearTimeout(timeoutId);
      
      const text = await res.text();
      const duration = ((Date.now() - start) / 1000).toFixed(2);
      
      // Ki·ªÉm tra response
      let ok = res.ok;
      let status = res.status;
      
      try {
        const jsonResponse = JSON.parse(text);
        ok = ok && jsonResponse.IsSuccess === true;
      } catch (e) {
        // N·∫øu kh√¥ng parse ƒë∆∞·ª£c JSON, xem nh∆∞ failed
        ok = false;
        status = 'INVALID_JSON';
      }
      
      return { ok, status, body: text, duration };
      
    } catch (err) {
      const duration = ((Date.now() - start) / 1000).toFixed(2);
      return { 
        ok: false, 
        error: err.name === 'AbortError' ? 'Timeout after 30s' : err.message, 
        duration 
      };
    }
  }

  // üîÅ Retry logic
  async function sendWithRetry(task, retries = 3, delay = 1000) {
    for (let attempt = 1; attempt <= retries; attempt++) {
      if (isStopped) return { ok: false, status: "STOPPED", attempt, duration: 0 };
      
      const res = await sendRequest(task);
      
      if (res.ok) return { ...res, attempt };
      
      if (attempt < retries) {
        appendLog(`   üîÅ [${task.index}] Retry ${attempt}/${retries}...`);
        await new Promise(r => setTimeout(r, delay));
      }
    }
    return { ok: false, attempt: retries, duration: 0 };
  }

  // üîó Test k·∫øt n·ªëi
  async function testConnection() {
    const endpoint = document.getElementById("endpoint").value.trim();
    const apiKey = document.getElementById("apiKey").value.trim();
    const pkg = document.getElementById("pkg").value.trim();
    
    if (!endpoint || !apiKey || !pkg) {
      alert("Vui l√≤ng nh·∫≠p endpoint, API key v√† package ƒë·ªÉ test k·∫øt n·ªëi!");
      return;
    }
    
    try {
      setLoadingState(true);
      appendLog("üîó ƒêang test k·∫øt n·ªëi...");
      
      const testUrl = `${endpoint}?mxpackage=${encodeURIComponent(pkg)}&opserial=1&mcid=TEST123&apikey=${encodeURIComponent(apiKey)}`;
      const response = await fetch(testUrl, { method: 'GET' });
      
      if (response.ok) {
        appendLog("‚úÖ K·∫øt n·ªëi th√†nh c√¥ng! Server ƒëang ho·∫°t ƒë·ªông.", false);
      } else {
        appendLog(`‚ùå K·∫øt n·ªëi th·∫•t b·∫°i! Status: ${response.status}`, true);
      }
    } catch (error) {
      appendLog(`‚ùå L·ªói k·∫øt n·ªëi: ${error.message}`, true);
    } finally {
      setLoadingState(false);
    }
  }

  // üì• T·∫°o v√† t·∫£i file m·∫´u CSV
  function downloadTemplate() {
    const header = "opserial,mcid,processtype\n";
    const rows = [
      "1,60:01:94:3A:74:B5,QA",
      "2,60:01:94:3A:74:B6,FA",
      "3,60:01:94:3A:74:B7,QC",
      "4,60:01:94:3A:74:B8,"
    ];
    
    const blob = new Blob(["\uFEFF" + header + rows.join("\n")], {type:'text/csv;charset=utf-8;'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; 
    a.download = `mes_template_${new Date().toISOString().slice(0,10)}.csv`; 
    a.click();
    URL.revokeObjectURL(url);
  }

  // üìÅ File import handler
  document.getElementById("importBtn").onclick = () => {
    document.getElementById("fileInput").click();
  };

  document.getElementById("fileInput").onchange = (e) => {
    const file = e.target.files[0];
    if (!file) return;
    
    const reader = new FileReader();
    reader.onload = (event) => {
      const content = event.target.result;
      const lines = content.split('\n').filter(line => line.trim());
      
      let dataLines = lines;
      if (lines[0].includes('opserial') && lines[0].includes('mcid')) {
        dataLines = lines.slice(1);
      }
      
      const formattedLines = dataLines.map(line => {
        const parts = line.split(/[\t,]/).map(part => part.trim());
        return parts.join(',');
      }).filter(line => line);
      
      document.getElementById("list").value = formattedLines.join('\n');
      appendLog(`üìÅ ƒê√£ import file: ${file.name} (${formattedLines.length} d√≤ng)`);
    };
    reader.onerror = () => {
      appendLog("‚ùå L·ªói ƒë·ªçc file!", true);
    };
    reader.readAsText(file);
    
    e.target.value = '';
  };

  // ‚èØÔ∏è Pause/Resume handler
  document.getElementById("pause").onclick = () => {
    isPaused = !isPaused;
    if (isPaused) {
      document.getElementById("pause").textContent = "‚ñ∂Ô∏è Ti·∫øp T·ª•c";
      document.getElementById("pause").className = "btn-success";
      appendLog("‚è∏Ô∏è ƒê√£ t·∫°m d·ª´ng");
    } else {
      document.getElementById("pause").textContent = "‚è∏Ô∏è T·∫°m D·ª´ng";
      document.getElementById("pause").className = "btn-warning";
      appendLog("‚ñ∂Ô∏è ƒê√£ ti·∫øp t·ª•c");
    }
  };

  // ‚èπÔ∏è Stop handler
  document.getElementById("stop").onclick = () => {
    if (!isStopped) {
      isStopped = true;
      appendLog("‚èπÔ∏è ƒêang d·ª´ng qu√° tr√¨nh g·ª≠i...");
    }
  };

  // üßπ Clear log handler
  document.getElementById("clearLog").onclick = () => {
    document.getElementById("log").innerHTML = "Log ƒë√£ ƒë∆∞·ª£c x√≥a...\n";
    document.getElementById("stats").style.display = 'none';
  };

  // üîó Test connection handler
  document.getElementById("testConnection").onclick = testConnection;

  // üì• Template download handler
  document.getElementById("downloadTemplate").onclick = (e) => {
    e.preventDefault();
    downloadTemplate();
    appendLog("üì• ƒê√£ t·∫£i xu·ªëng file m·∫´u CSV");
  };

  // üöÄ Main process
  async function runBatchProcess() {
    try {
      setLoadingState(true);
      const { endpoint, apiKey, pkg, lines } = validateInputs();
      
      const bar = document.getElementById("bar");
      const total = lines.length;
      let done = 0;
      const results = [];

      appendLog(`‚ö° B·∫Øt ƒë·∫ßu g·ª≠i ${total} d√≤ng ƒë·∫øn package: ${pkg}`);
      appendLog(`üåê Endpoint: ${endpoint}`);
      appendLog(`üîë API Key: ${apiKey.slice(0, 8)}...`);
      appendLog(`‚è∞ T·ªëc ƒë·ªô: 1 request/l·∫ßn, c√°ch nhau 2-5 gi√¢y`);
      
      currentBatchStart = Date.now();
      const queue = lines.map((line, idx) => {
        const [opserial, mcid, processtype] = line.split(",").map(x => x.trim());
        return { endpoint, apiKey, pkg, opserial, mcid, processtype, index: idx + 1 };
      });

      async function processQueue() {
        while (queue.length > 0 && !isStopped) {
          if (isPaused) {
            await new Promise(r => setTimeout(r, 500));
            continue;
          }

          const task = queue.shift();
          if (!task || !task.opserial || !task.mcid) {
            appendLog(`‚ö†Ô∏è B·ªè qua d√≤ng kh√¥ng h·ª£p l·ªá`);
            continue;
          }

          appendLog(`üöÄ [${task.index}] G·ª≠i ${task.mcid} (op ${task.opserial}${task.processtype ? ',' + task.processtype : ''})...`);

          const res = await sendWithRetry(task);
          const icon = res.ok ? "‚úÖ" : (res.status === "STOPPED" ? "‚èπÔ∏è" : "‚ùå");
          const retryNote = res.attempt > 1 ? ` üîÅ(${res.attempt} l·∫ßn)` : '';
          const timeNote = res.duration ? ` (${res.duration}s)` : '';
          appendLog(`${icon} [${task.index}] ${task.mcid} ‚Üí ${res.status || res.error || 'error'}${retryNote}${timeNote}`);

          results.push({
            ...task,
            status: res.status || res.error || "ERROR",
            success: res.ok,
            retries: res.attempt,
            duration: res.duration
          });

          done++;
          const progress = (done/total)*100;
          bar.style.width = `${progress}%`;
          bar.setAttribute('data-progress', `${Math.round(progress)}%`);
          
          updateStats(results, total, Date.now() - currentBatchStart);
          
          if (queue.length > 0 && !isStopped) {
            const delay = Math.floor(Math.random() * 3000) + 2000;
            appendLog(`‚è≥ Ch·ªù ${delay/1000}s tr∆∞·ªõc khi g·ª≠i request ti·∫øp theo...`);
            await new Promise(r => setTimeout(r, delay));
          }
        }
      }

      await processQueue();

      const totalTime = Date.now() - currentBatchStart;
      const avg = totalTime > 0 ? (total / (totalTime / 1000)) : 0;
      
      if (isStopped) {
        appendLog(`\n‚èπÔ∏è ƒê√£ d·ª´ng th·ªß c√¥ng sau ${formatTime(totalTime)}.`);
        appendLog(`üìä ƒê√£ x·ª≠ l√Ω: ${done}/${total} requests`);
      } else {
        appendLog(`\nüéØ Ho√†n t·∫•t to√†n b·ªô trong ${formatTime(totalTime)} (${avg.toFixed(2)} req/s).`);
      }
      
      window._batchResults = results;
      
    } catch (error) {
      appendLog(`‚ùå L·ªói: ${error.message}`, true);
      console.error('Batch process error:', error);
    } finally {
      setLoadingState(false);
      if (window._batchResults) {
        updateStats(window._batchResults, window._batchResults.length, Date.now() - currentBatchStart);
      }
    }
  }

  // ‚ñ∂Ô∏è Run handler
  document.getElementById("run").onclick = runBatchProcess;

  // üíæ Export handler
  document.getElementById("export").onclick = () => {
    const data = window._batchResults || [];
    if (!data.length) return alert("Ch∆∞a c√≥ d·ªØ li·ªáu ƒë·ªÉ xu·∫•t!");
    
    const header = "index,opserial,mcid,processtype,status,success,retries,duration(s)\n";
    const rows = data.map(r => `${r.index},${r.opserial},${r.mcid},${r.processtype||''},${r.status},${r.success},${r.retries},${r.duration}`);
    const blob = new Blob(["\uFEFF" + header + rows.join("\n")], {type:'text/csv;charset=utf-8;'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; 
    a.download = `mes_batch_result_${new Date().toISOString().slice(0,19).replace(/:/g,'-')}.csv`; 
    a.click();
    URL.revokeObjectURL(url);
    
    appendLog(`üíæ ƒê√£ xu·∫•t file: ${a.download}`);
  };

  // Kh·ªüi t·∫°o ·ª©ng d·ª•ng
  document.addEventListener('DOMContentLoaded', function() {
    appendLog("‚úÖ ·ª®ng d·ª•ng ƒë√£ s·∫µn s√†ng!");
    appendLog("üí° H∆∞·ªõng d·∫´n: Nh·∫≠p API Key, Package v√† danh s√°ch MCID, sau ƒë√≥ click 'B·∫Øt ƒê·∫ßu G·ª≠i'");
    console.log("MES QR Scanner initialized");
  });
  </script>
</body>
</html>

