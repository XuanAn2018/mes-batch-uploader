<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="utf-8">
  <title>MES Batch Sender ğŸš€</title>
  <style>
    body { font-family: Calibri, sans-serif; background:#f7f9fc; margin:0; padding:0; }
    .container {
      max-width: 900px; margin: 30px auto; background: white;
      padding: 25px 30px; border-radius: 14px;
      box-shadow: 0 0 12px rgba(0,0,0,0.1);
    }
    h1 { text-align:center; color:#0057b7; }
    label { font-weight:600; display:block; margin-top:10px; }
    input, textarea, button {
      width:100%; margin:6px 0; padding:10px; border-radius:6px;
      border:1px solid #ccc; font-size:15px;
    }
    textarea { resize:vertical; }
    button {
      background:#0057b7; color:white; border:none; font-weight:bold;
      cursor:pointer; transition:0.3s;
    }
    button:hover { background:#0072ff; }
    #progress { width:100%; background:#e5e5e5; border-radius:5px; margin-top:10px; height:14px; }
    #bar { height:14px; background:linear-gradient(90deg,#00c851,#007e33); width:0%; transition:width 0.3s; }
    pre {
      background:#f0f0f0; padding:10px; border-radius:8px;
      max-height:400px; overflow-y:auto; font-size:13px;
      white-space:pre-wrap;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸš€ MES Batch Sender</h1>
    <p>Nháº­p <strong>package</strong> (vÃ­ dá»¥: <code>M_LSV-0007_1_LSV0001LRG002001_01_01</code>) vÃ  danh sÃ¡ch <strong>opserial, mcid[, processtype]</strong> Ä‘á»ƒ gá»­i hÃ ng loáº¡t.</p>

    <label>ğŸ”¹ Package:</label>
    <input id="pkg" placeholder="M_LSV-0007_1_LSV0001LRG002001_01_01">

    <label>ğŸ”¹ Danh sÃ¡ch (má»—i dÃ²ng: opserial,mcid[,processtype])</label>
    <textarea id="list" rows="8" placeholder="1,M10002390
2,M10002391,FA
3,M10002396,QA"></textarea>

    <label>ğŸ”¹ Endpoint:</label>
    <input id="endpoint" value="https://mes-system.chiscoong-cloudflare-com.workers.dev/">

    <button id="run">â–¶ï¸ Gá»­i hÃ ng loáº¡t</button>
    <div id="progress"><div id="bar"></div></div>

    <h3>ğŸ“‹ Log tiáº¿n trÃ¬nh:</h3>
    <pre id="log">ChÆ°a cÃ³ hoáº¡t Ä‘á»™ng nÃ o...</pre>
    <button id="export" style="background:#28a745">ğŸ’¾ Xuáº¥t káº¿t quáº£ CSV</button>
  </div>

  <script>
  // ğŸ§© HÃ m tÃ¡ch package thÃ nh cÃ¡c tham sá»‘ MES
  function parsePackage(mx) {
  // ğŸ†• phiÃªn báº£n regex cáº£i tiáº¿n
  const pattern = /^M_[A-Z0-9-]+_\d+_([A-Z]+\d+)([A-Z]{3})(\d{3})_(\d{2,3})_(\d{2,3})$/;
  const m = mx.match(pattern);
  if (!m) throw new Error("âŒ Package khÃ´ng Ä‘Ãºng Ä‘á»‹nh dáº¡ng MES!");
  const stylecode = m[1];
  const stylesize = m[2];
  const stylecolorserial = m[3];
  const revno = m[4].padStart(3, "0");
  const oprevno = m[5].padStart(3, "0");
  return { stylecode, stylesize, stylecolorserial, revno, oprevno };
}

  document.getElementById("run").onclick = async () => {
    const pkg = document.getElementById("pkg").value.trim();
    const lines = document.getElementById("list").value.split("\n").map(x=>x.trim()).filter(Boolean);
    const endpoint = document.getElementById("endpoint").value.trim();
    const log = document.getElementById("log");
    const bar = document.getElementById("bar");
    const total = lines.length;
    let done = 0;
    const results = [];

    if (!pkg) return alert("â— Vui lÃ²ng nháº­p package!");
    if (!lines.length) return alert("â— Vui lÃ²ng nháº­p danh sÃ¡ch cÃ´ng Ä‘oáº¡n / mÃ¡y!");

    let base;
    try {
      base = parsePackage(pkg);
    } catch (err) {
      alert(err.message);
      return;
    }

    log.textContent = `â³ Báº¯t Ä‘áº§u gá»­i ${total} dÃ²ng...\n`;

    for (const line of lines) {
      const [opserial, mcid, processtype] = line.split(",").map(x=>x.trim());
      if (!opserial || !mcid) {
        log.textContent += `âš ï¸ Bá» qua dÃ²ng khÃ´ng há»£p lá»‡: "${line}"\n`;
        continue;
      }

      // ğŸ”— Táº¡o URL endpoint hoÃ n chá»‰nh (KHÃ”NG cÃ³ mxpackage)
      const url = `${endpoint}?stylecode=${base.stylecode}&stylesize=${base.stylesize}&stylecolorserial=${base.stylecolorserial}&revno=${base.revno}&oprevno=${base.oprevno}&opserial=${opserial}&mcid=${mcid}${processtype ? `&processtype=${processtype}` : ''}`;

      try {
        const res = await fetch(url);
        const text = await res.text();
        const ok = res.ok && /"IsSuccess":\s*true/.test(text);
        const icon = ok ? "âœ…" : "âŒ";
        log.textContent += `${icon} ${mcid} (op ${opserial}${processtype?','+processtype:''}) â†’ ${res.status}\n`;
        if (!ok) log.textContent += `   â†³ Ná»™i dung: ${text.substring(0,150)}...\n`;
        results.push({ opserial, mcid, processtype, status: res.status, success: ok, body: text });
      } catch (err) {
        log.textContent += `âŒ Lá»—i gá»­i ${mcid}: ${err.message}\n`;
        results.push({ opserial, mcid, processtype, status: "ERROR", error: err.message });
      }

      done++;
      bar.style.width = `${(done/total)*100}%`;
      await new Promise(r => setTimeout(r, 200)); // trÃ¡nh bá»‹ rate limit
    }

    log.textContent += "\nğŸ¯ HoÃ n táº¥t gá»­i toÃ n bá»™.\n";
    window._batchResults = results;
  };

  // ğŸ’¾ Xuáº¥t káº¿t quáº£ CSV
  document.getElementById("export").onclick = () => {
    const data = window._batchResults || [];
    if (!data.length) return alert("ChÆ°a cÃ³ dá»¯ liá»‡u Ä‘á»ƒ xuáº¥t!");
    const header = "opserial,mcid,processtype,status,success\n";
    const rows = data.map(r=>`${r.opserial},${r.mcid},${r.processtype||''},${r.status},${r.success}`);
    const blob = new Blob([header + rows.join("\n")], {type:'text/csv'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; a.download = "mes_batch_result.csv"; a.click();
  };
  </script>
</body>
</html>
