<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="utf-8">
  <title>MES QR SCANNER</title>
  <style>
    :root {
      --primary: #0057b7;
      --primary-light: #0072ff;
      --success: #28a745;
      --warning: #ffc107;
      --danger: #dc3545;
      --info: #17a2b8;
      --light: #f8f9fa;
      --dark: #343a40;
      --gray: #6c757d;
      --border-radius: 8px;
      --box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      --transition: all 0.3s ease;
    }
    
    * {
      box-sizing: border-box;
    }
    
    body { 
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
      background: linear-gradient(135deg, #f5f7fa 0%, #e4e8f0 100%);
      margin: 0; 
      padding: 20px; 
      color: #333;
      line-height: 1.6;
    }
    
    .container {
      max-width: 1000px; 
      margin: 0 auto; 
      background: white;
      padding: 30px; 
      border-radius: 12px;
      box-shadow: var(--box-shadow);
    }
    
    h1 { 
      text-align: center; 
      color: var(--primary); 
      margin-bottom: 10px;
      font-weight: 700;
    }
    
    .subtitle {
      text-align: center;
      color: var(--gray);
      margin-bottom: 30px;
      font-size: 1.1rem;
    }
    
    .card {
      background: var(--light);
      border-radius: var(--border-radius);
      padding: 20px;
      margin-bottom: 20px;
      border-left: 4px solid var(--primary);
    }
    
    .card-title {
      font-weight: 600;
      margin-top: 0;
      color: var(--primary);
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    label { 
      font-weight: 600; 
      display: block; 
      margin-top: 15px; 
      margin-bottom: 5px;
    }
    
    input, textarea, button {
      width: 100%; 
      margin: 6px 0; 
      padding: 12px; 
      border-radius: var(--border-radius);
      border: 1px solid #ddd; 
      font-size: 15px;
      transition: var(--transition);
    }
    
    input:focus, textarea:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 2px rgba(0, 87, 183, 0.2);
    }
    
    textarea { 
      resize: vertical; 
      min-height: 120px;
      font-family: 'Courier New', monospace;
    }
    
    button {
      background: var(--primary); 
      color: white; 
      border: none; 
      font-weight: 600;
      cursor: pointer; 
      transition: var(--transition);
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }
    
    button:hover { 
      background: var(--primary-light); 
      transform: translateY(-2px);
    }
    
    button:disabled { 
      background: var(--gray); 
      cursor: not-allowed;
      transform: none;
    }
    
    #progress { 
      width: 100%; 
      background: #e5e5e5; 
      border-radius: 10px; 
      margin: 20px 0; 
      height: 16px; 
      overflow: hidden;
    }
    
    #bar { 
      height: 16px; 
      background: linear-gradient(90deg, #00c851, #007e33); 
      width: 0%; 
      transition: width 0.5s;
      border-radius: 10px;
    }
    
    pre {
      background: #f8f9fa; 
      padding: 15px; 
      border-radius: var(--border-radius);
      max-height: 400px; 
      overflow-y: auto; 
      font-size: 13px;
      white-space: pre-wrap; 
      line-height: 1.4;
      font-family: 'Courier New', monospace;
      border: 1px solid #e9ecef;
    }
    
    .btn-row { 
      display: flex; 
      gap: 10px; 
      margin-top: 15px; 
    }
    
    .btn-row button { 
      flex: 1; 
    }
    
    .file-input-row { 
      display: flex; 
      gap: 10px; 
      align-items: center; 
      margin-top: 10px;
    }
    
    .file-input-row input[type="file"] { 
      flex: 2; 
      padding: 8px;
    }
    
    .file-input-row button { 
      flex: 1; 
    }
    
    .stats { 
      background: #e8f4fd; 
      padding: 15px; 
      border-radius: var(--border-radius); 
      margin: 15px 0;
      font-weight: 600;
      border-left: 4px solid var(--info);
    }
    
    .error { color: var(--danger); }
    .success { color: var(--success); }
    
    .help-text {
      font-size: 0.85rem;
      color: var(--gray);
      margin-top: 5px;
      font-style: italic;
    }
    
    .placeholder {
      color: #aaa;
    }
    
    .template-download {
      display: inline-flex;
      align-items: center;
      gap: 5px;
      color: var(--primary);
      text-decoration: none;
      font-weight: 600;
      margin-top: 10px;
      padding: 8px 12px;
      background: rgba(0, 87, 183, 0.1);
      border-radius: var(--border-radius);
      transition: var(--transition);
    }
    
    .template-download:hover {
      background: rgba(0, 87, 183, 0.2);
    }
    
    .icon {
      font-size: 1.2rem;
    }
    
    .status-running { color: var(--success); }
    .status-paused { color: var(--warning); }
    .status-stopped { color: var(--danger); }
    
    @media (max-width: 768px) {
      .container {
        padding: 20px;
      }
      
      .btn-row {
        flex-direction: column;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>‚ö° MES QR SCANNER ‚ö°</h1>
    <p class="subtitle">C√¥ng c·ª• g·ª≠i l·ªánh MES t·ª± ƒë·ªông v·ªõi t·ªëc ƒë·ªô m√¥ ph·ªèng thao t√°c ng∆∞·ªùi d√πng</p>

    <div class="card">
      <h3 class="card-title">üì¶ Th√¥ng tin Package</h3>
      <label>Package (mxpackage):</label>
      <input id="pkg" placeholder="M_XXX-XXXX_X_XXXXXXXXXXXXXXXX_XX" value="M_XXX-XXXX_X_XXXXXXXXXXXXXXXX_XX">
      <div class="help-text">M·ªói package n√™n ƒë∆∞·ª£c x·ª≠ l√Ω trong m·ªôt file CSV ri√™ng</div>
    </div>

    <div class="card">
      <h3 class="card-title">üìã D·ªØ li·ªáu c·∫ßn x·ª≠ l√Ω</h3>
      <label>Danh s√°ch (m·ªói d√≤ng: opserial,mcid[,processtype]):</label>
      <textarea id="list" placeholder="1,M10002390
2,M10002391,FA
3,M10002396,QA">1,M10002390
2,M10002391,FA
3,M10002396,QA</textarea>
      
      <label>Import t·ª´ file CSV/TXT:</label>
      <div class="file-input-row">
        <input type="file" id="fileInput" accept=".csv,.txt">
        <button id="importBtn" style="background:#6c757d">üìÅ Import File</button>
      </div>
      
      <a href="#" id="downloadTemplate" class="template-download">
        üì• T·∫£i file m·∫´u CSV
      </a>
      <div class="help-text">
        C·∫•u tr√∫c file: opserial (c·ªôt A), mcid (c·ªôt B), processtype (c·ªôt C - t√πy ch·ªçn)
      </div>
    </div>

    <div class="card">
      <h3 class="card-title">‚öôÔ∏è C·∫•u h√¨nh k·∫øt n·ªëi</h3>
      <label>Endpoint:</label>
      <input id="endpoint" value="https://mes-system.chiscoong-cloudflare-com.workers.dev/">
      
      <div class="help-text">
        <strong>L∆∞u √Ω:</strong> H·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông gi·ªõi h·∫°n t·ªëc ƒë·ªô g·ª≠i (1 request/l·∫ßn, c√°ch nhau 2-5 gi√¢y) ƒë·ªÉ m√¥ ph·ªèng thao t√°c ng∆∞·ªùi d√πng th·ª±c t·∫ø
      </div>
    </div>

    <div class="btn-row">
      <button id="run">‚ñ∂Ô∏è B·∫Øt ƒë·∫ßu g·ª≠i</button>
      <button id="pause" style="background:#ffc107; color: #000; display:none;">‚è∏Ô∏è T·∫°m d·ª´ng</button>
      <button id="stop" style="background:#dc3545; display:none;">‚èπÔ∏è D·ª´ng l·∫°i</button>
    </div>

    <div id="progress">
      <div id="bar"></div>
    </div>

    <div id="stats" class="stats" style="display:none;">
      üìä Th·ªëng k√™: ƒêang x·ª≠ l√Ω...
    </div>

    <h3>üìã Log ti·∫øn tr√¨nh:</h3>
    <pre id="log">Ch∆∞a c√≥ ho·∫°t ƒë·ªông n√†o...</pre>
    
    <div class="btn-row">
      <button id="export" style="background:#28a745">üíæ Xu·∫•t k·∫øt qu·∫£ CSV</button>
      <button id="clearLog" style="background:#6c757d">üóëÔ∏è X√≥a Log</button>
      <button id="testConnection" style="background:#17a2b8">üîó Test K·∫øt n·ªëi</button>
    </div>
  </div>

  <script>
  let isPaused = false;
  let isStopped = false;
  let currentBatchStart = null;

  // ‚è±Ô∏è Helper format mm:ss
  function formatTime(ms) {
    const totalSec = Math.floor(ms / 1000);
    const m = Math.floor(totalSec / 60).toString().padStart(2, "0");
    const s = (totalSec % 60).toString().padStart(2, "0");
    return `${m}:${s}`;
  }

  // üìä C·∫≠p nh·∫≠t th·ªëng k√™
  function updateStats(results, total, elapsedTime) {
    const statsEl = document.getElementById("stats");
    if (!results.length) {
      statsEl.style.display = 'none';
      return;
    }
    
    const success = results.filter(r => r.success).length;
    const failed = results.filter(r => !r.success && r.status !== "STOPPED").length;
    const stopped = results.filter(r => r.status === "STOPPED").length;
    const pending = total - results.length;
    
    const avgRetries = results.length > 0 
      ? (results.reduce((sum, r) => sum + (r.retries || 0), 0) / results.length).toFixed(2)
      : "0.00";
    
    const avgDuration = results.length > 0
      ? (results.reduce((sum, r) => sum + (parseFloat(r.duration) || 0), 0) / results.length).toFixed(2)
      : "0.00";
    
    const currentRate = elapsedTime > 0 ? (results.length / (elapsedTime / 1000)).toFixed(2) : "0.00";
    
    statsEl.innerHTML = `
      üìä Th·ªëng k√™: 
      T·ªïng: ${total} | 
      ƒê√£ x·ª≠ l√Ω: ${results.length} | 
      Th√†nh c√¥ng: <span style="color:green">${success}</span> | 
      Th·∫•t b·∫°i: <span style="color:red">${failed}</span> | 
      ƒê√£ d·ª´ng: ${stopped} | 
      Ch·ªù: ${pending} |
      Retry TB: ${avgRetries} | 
      Th·ªùi gian TB: ${avgDuration}s |
      T·ªëc ƒë·ªô: ${currentRate} req/s
    `;
    statsEl.style.display = 'block';
  }

  // üö® Validation chi ti·∫øt
  function validateInputs() {
    const pkg = document.getElementById("pkg").value.trim();
    const lines = document.getElementById("list").value.split("\n").map(x => x.trim()).filter(Boolean);
    const endpoint = document.getElementById("endpoint").value.trim();
    
    if (!pkg) throw new Error("‚ùó Vui l√≤ng nh·∫≠p package!");
    if (!lines.length) throw new Error("‚ùó Vui l√≤ng nh·∫≠p danh s√°ch c√¥ng ƒëo·∫°n / m√°y!");
    if (!endpoint) throw new Error("‚ùó Vui l√≤ng nh·∫≠p endpoint!");
    
    // Validate endpoint URL
    try {
      new URL(endpoint);
    } catch (e) {
      throw new Error("‚ùó Endpoint kh√¥ng h·ª£p l·ªá!");
    }
    
    // Validate t·ª´ng d√≤ng
    const invalidLines = [];
    lines.forEach((line, idx) => {
      const parts = line.split(",").map(x => x.trim());
      if (parts.length < 2 || !parts[0] || !parts[1]) {
        invalidLines.push(`D√≤ng ${idx + 1}: "${line}"`);
      }
    });
    
    if (invalidLines.length > 0) {
      throw new Error(`D√≤ng kh√¥ng h·ª£p l·ªá:\n${invalidLines.join("\n")}`);
    }
    
    return { pkg, lines, endpoint };
  }

  // üìù Append log v·ªõi auto-scroll
  function appendLog(message, isError = false) {
    const log = document.getElementById("log");
    const timestamp = new Date().toLocaleTimeString();
    const logEntry = `[${timestamp}] ${message}`;
    
    log.textContent += logEntry + "\n";
    log.scrollTop = log.scrollHeight;
    
    // Log ra console ƒë·ªÉ debug
    if (isError) {
      console.error(message);
    } else {
      console.log(message);
    }
  }

  // ‚öôÔ∏è Loading state management
  function setLoadingState(loading) {
    document.getElementById("run").disabled = loading;
    document.getElementById("export").disabled = loading;
    document.getElementById("importBtn").disabled = loading;
    document.getElementById("testConnection").disabled = loading;
    document.getElementById("pause").style.display = loading ? "block" : "none";
    document.getElementById("stop").style.display = loading ? "block" : "none";
    
    if (!loading) {
      isPaused = false;
      isStopped = false;
      document.getElementById("pause").textContent = "‚è∏Ô∏è T·∫°m d·ª´ng";
    }
  }

  // üìß G·ª≠i request v·ªõi timeout
  async function sendRequest({endpoint, pkg, opserial, mcid, processtype}) {
    const url = `${endpoint}?mxpackage=${encodeURIComponent(pkg)}&opserial=${opserial}&mcid=${mcid}${processtype ? `&processtype=${processtype}` : ''}`;
    const start = Date.now();
    
    try {
      const controller = new AbortController();
      const timeoutId = setTimeout(() => controller.abort(), 30000); // 30s timeout
      
      const res = await fetch(url, {
        method: 'GET',
        signal: controller.signal,
        headers: {
          'Accept': 'application/json',
        },
        mode: 'cors' // Explicitly set CORS mode
      });
      
      clearTimeout(timeoutId);
      
      const text = await res.text();
      const duration = ((Date.now() - start) / 1000).toFixed(2);
      
      // Ki·ªÉm tra response
      let ok = res.ok;
      let status = res.status;
      
      try {
        const jsonResponse = JSON.parse(text);
        ok = ok && jsonResponse.IsSuccess === true;
      } catch (e) {
        // N·∫øu kh√¥ng parse ƒë∆∞·ª£c JSON, xem nh∆∞ failed
        ok = false;
        status = 'INVALID_JSON';
      }
      
      return { ok, status, body: text, duration };
      
    } catch (err) {
      const duration = ((Date.now() - start) / 1000).toFixed(2);
      return { 
        ok: false, 
        error: err.name === 'AbortError' ? 'Timeout after 30s' : err.message, 
        duration 
      };
    }
  }

  // üîÅ Retry logic
  async function sendWithRetry(task, retries = 3, delay = 1000) {
    for (let attempt = 1; attempt <= retries; attempt++) {
      if (isStopped) return { ok: false, status: "STOPPED", attempt, duration: 0 };
      
      const res = await sendRequest(task);
      
      if (res.ok) return { ...res, attempt };
      
      if (attempt < retries) {
        appendLog(`   üîÅ [${task.index}] Retry ${attempt}/${retries}...`);
        await new Promise(r => setTimeout(r, delay));
      }
    }
    return { ok: false, attempt: retries, duration: 0 };
  }

  // üîó Test k·∫øt n·ªëi
  async function testConnection() {
    const endpoint = document.getElementById("endpoint").value.trim();
    const pkg = document.getElementById("pkg").value.trim();
    
    if (!endpoint || !pkg) {
      alert("Vui l√≤ng nh·∫≠p endpoint v√† package ƒë·ªÉ test k·∫øt n·ªëi!");
      return;
    }
    
    try {
      setLoadingState(true);
      appendLog("üîó ƒêang test k·∫øt n·ªëi...");
      
      const testUrl = `${endpoint}?mxpackage=${encodeURIComponent(pkg)}&opserial=1&mcid=TEST123`;
      const response = await fetch(testUrl, { method: 'GET' });
      
      if (response.ok) {
        appendLog("‚úÖ K·∫øt n·ªëi th√†nh c√¥ng! Server ƒëang ho·∫°t ƒë·ªông.", false);
      } else {
        appendLog(`‚ùå K·∫øt n·ªëi th·∫•t b·∫°i! Status: ${response.status}`, true);
      }
    } catch (error) {
      appendLog(`‚ùå L·ªói k·∫øt n·ªëi: ${error.message}`, true);
    } finally {
      setLoadingState(false);
    }
  }

  // üì• T·∫°o v√† t·∫£i file m·∫´u CSV
  function downloadTemplate() {
    const header = "opserial,mcid,processtype\n";
    const rows = [
      "1,M10002390,QA",
      "2,M10002391,FA",
      "3,M10002396,",
      "4,M10002397,QC"
    ];
    
    const blob = new Blob(["\uFEFF" + header + rows.join("\n")], {type:'text/csv;charset=utf-8;'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; 
    a.download = `mes_template.csv`; 
    a.click();
    URL.revokeObjectURL(url);
  }

  // üìÅ File import handler
  document.getElementById("importBtn").onclick = () => {
    document.getElementById("fileInput").click();
  };

  document.getElementById("fileInput").onchange = (e) => {
    const file = e.target.files[0];
    if (!file) return;
    
    const reader = new FileReader();
    reader.onload = (event) => {
      // X·ª≠ l√Ω d·ªØ li·ªáu CSV
      const content = event.target.result;
      const lines = content.split('\n').filter(line => line.trim());
      
      // B·ªè qua header n·∫øu c√≥
      let dataLines = lines;
      if (lines[0].includes('opserial') && lines[0].includes('mcid')) {
        dataLines = lines.slice(1);
      }
      
      // Chuy·ªÉn ƒë·ªïi sang ƒë·ªãnh d·∫°ng opserial,mcid,processtype
      const formattedLines = dataLines.map(line => {
        // X·ª≠ l√Ω c·∫£ tab v√† comma nh∆∞ delimiter
        const parts = line.split(/[\t,]/).map(part => part.trim());
        return parts.join(',');
      }).filter(line => line);
      
      document.getElementById("list").value = formattedLines.join('\n');
      appendLog(`üìÅ ƒê√£ import file: ${file.name} (${file.size} bytes, ${formattedLines.length} d√≤ng)`);
    };
    reader.onerror = () => {
      appendLog("‚ùå L·ªói ƒë·ªçc file!", true);
    };
    reader.readAsText(file);
    
    // Reset file input
    e.target.value = '';
  };

  // ‚èØÔ∏è Pause/Resume handler
  document.getElementById("pause").onclick = () => {
    isPaused = !isPaused;
    document.getElementById("pause").textContent = isPaused ? "‚ñ∂Ô∏è Ti·∫øp t·ª•c" : "‚è∏Ô∏è T·∫°m d·ª´ng";
    appendLog(isPaused ? "‚è∏Ô∏è ƒê√£ t·∫°m d·ª´ng" : "‚ñ∂Ô∏è ƒê√£ ti·∫øp t·ª•c");
  };

  // ‚èπÔ∏è Stop handler
  document.getElementById("stop").onclick = () => {
    if (!isStopped) {
      isStopped = true;
      appendLog("‚èπÔ∏è ƒêang d·ª´ng qu√° tr√¨nh g·ª≠i...");
    }
  };

  // üßπ Clear log handler
  document.getElementById("clearLog").onclick = () => {
    document.getElementById("log").textContent = "Log ƒë√£ ƒë∆∞·ª£c x√≥a...\n";
  };

  // üîó Test connection handler
  document.getElementById("testConnection").onclick = testConnection;

  // üì• Template download handler
  document.getElementById("downloadTemplate").onclick = (e) => {
    e.preventDefault();
    downloadTemplate();
    appendLog("üì• ƒê√£ t·∫£i xu·ªëng file m·∫´u CSV");
  };

  // üöÄ Main process
  async function runBatchProcess() {
    try {
      setLoadingState(true);
      const { pkg, lines, endpoint } = validateInputs();
      
      const bar = document.getElementById("bar");
      const total = lines.length;
      let done = 0;
      const results = [];

      appendLog(`‚ö° B·∫Øt ƒë·∫ßu g·ª≠i ${total} d√≤ng (t·ªëc ƒë·ªô m√¥ ph·ªèng ng∆∞·ªùi d√πng: 1 request/l·∫ßn, c√°ch nhau 2-5 gi√¢y)...`);
      
      currentBatchStart = Date.now();
      const queue = lines.map((line, idx) => {
        const [opserial, mcid, processtype] = line.split(",").map(x => x.trim());
        return { opserial, mcid, processtype, index: idx + 1 };
      });

      async function processQueue() {
        while (queue.length > 0 && !isStopped) {
          if (isPaused) {
            await new Promise(r => setTimeout(r, 500));
            continue;
          }

          const task = queue.shift();
          if (!task || !task.opserial || !task.mcid) {
            appendLog(`‚ö†Ô∏è B·ªè qua d√≤ng kh√¥ng h·ª£p l·ªá`);
            continue;
          }

          appendLog(`üöÄ [${task.index}] G·ª≠i ${task.mcid} (op ${task.opserial}${task.processtype ? ',' + task.processtype : ''})...`);

          const res = await sendWithRetry({ endpoint, pkg, ...task });
          const icon = res.ok ? "‚úÖ" : (res.status === "STOPPED" ? "‚èπÔ∏è" : "‚ùå");
          const retryNote = res.attempt > 1 ? ` üîÅ(${res.attempt} l·∫ßn)` : "";
          const timeNote = res.duration ? ` (${res.duration}s)` : "";
          appendLog(`${icon} [${task.index}] ${task.mcid} ‚Üí ${res.status || res.error || 'error'}${retryNote}${timeNote}`);

          results.push({
            ...task,
            status: res.status || res.error || "ERROR",
            success: res.ok,
            retries: res.attempt,
            duration: res.duration
          });

          done++;
          bar.style.width = `${(done/total)*100}%`;
          
          // C·∫≠p nh·∫≠t th·ªëng k√™
          updateStats(results, total, Date.now() - currentBatchStart);
          
          // T·∫°m d·ª´ng ng·∫´u nhi√™n 2-5 gi√¢y tr∆∞·ªõc khi g·ª≠i request ti·∫øp theo
          if (queue.length > 0 && !isStopped) {
            const delay = Math.floor(Math.random() * 3000) + 2000; // 2-5 gi√¢y
            appendLog(`‚è≥ Ch·ªù ${delay/1000}s tr∆∞·ªõc khi g·ª≠i request ti·∫øp theo...`);
            await new Promise(r => setTimeout(r, delay));
          }
        }
      }

      await processQueue();

      const totalTime = Date.now() - currentBatchStart;
      const avg = totalTime > 0 ? (total / (totalTime / 1000)) : 0;
      
      if (isStopped) {
        appendLog(`\n‚èπÔ∏è ƒê√£ d·ª´ng th·ªß c√¥ng sau ${formatTime(totalTime)}.`);
        appendLog(`üìä ƒê√£ x·ª≠ l√Ω: ${done}/${total} requests`);
      } else {
        appendLog(`\nüéØ Ho√†n t·∫•t to√†n b·ªô trong ${formatTime(totalTime)} (${avg.toFixed(2)} req/s).`);
      }
      
      window._batchResults = results;
      
    } catch (error) {
      appendLog(`‚ùå L·ªói: ${error.message}`, true);
      console.error('Batch process error:', error);
    } finally {
      setLoadingState(false);
      // C·∫≠p nh·∫≠t th·ªëng k√™ cu·ªëi c√πng
      if (window._batchResults) {
        updateStats(window._batchResults, window._batchResults.length, Date.now() - currentBatchStart);
      }
    }
  }

  // ‚ñ∂Ô∏è Run handler
  document.getElementById("run").onclick = runBatchProcess;

  // üíæ Export handler
  document.getElementById("export").onclick = () => {
    const data = window._batchResults || [];
    if (!data.length) return alert("Ch∆∞a c√≥ d·ªØ li·ªáu ƒë·ªÉ xu·∫•t!");
    
    const header = "index,opserial,mcid,processtype,status,success,retries,duration(s)\n";
    const rows = data.map(r => `${r.index},${r.opserial},${r.mcid},${r.processtype||''},${r.status},${r.success},${r.retries},${r.duration}`);
    const blob = new Blob(["\uFEFF" + header + rows.join("\n")], {type:'text/csv;charset=utf-8;'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; 
    a.download = `mes_batch_result_${new Date().toISOString().slice(0,19).replace(/:/g,'-')}.csv`; 
    a.click();
    URL.revokeObjectURL(url);
    
    appendLog(`üíæ ƒê√£ xu·∫•t file: ${a.download}`);
  };

  // Th√™m event listener ƒë·ªÉ debug
  document.addEventListener('DOMContentLoaded', function() {
    appendLog("‚úÖ ·ª®ng d·ª•ng ƒë√£ s·∫µn s√†ng!");
    console.log("MES Batch Sender initialized");
  });
  </script>
</body>
</html>

